<!-- admin_dashboard -->
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin Dashboard</title>
    <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">
    <style>
        body {
            margin: 0;
            font-family: Arial, sans-serif;
            background-color: #f5f5f5;
        }
        
        .sidebar {
            position: fixed;
            left: -250px;
            top: 0;
            width: 250px;
            height: 100%;
            background-color: #2980b9;
            transition: left 0.3s ease;
            z-index: 1001;
            padding-top: 60px;
            color: white;
            box-shadow: 2px 0 5px rgba(0,0,0,0.1);
        }
        
        .sidebar.open {
            left: 0;
        }
        
        .menu-items {
            padding: 15px;
        }
        
        .dropdown-btn {
            background: none;
            border: none;
            color: white;
            padding: 10px;
            width: 100%;
            text-align: left;
            font-size: 16px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: space-between;
        }
        
        .dropdown-btn:hover {
            background-color: #3498db;
        }
        
        .dropdown-content {
            display: none;
            padding-left: 20px;
            background-color: rgba(255, 255, 255, 0.1);
            margin-top: 5px;
        }
        
        .dropdown-content.show {
            display: block !important;
        }
        
        .dropdown-content button {
            background: none;
            border: none;
            color: white;
            padding: 8px;
            width: 100%;
            text-align: left;
            cursor: pointer;
            margin: 2px 0;
            border-radius: 4px;
            transition: background-color 0.2s;
        }
        
        .dropdown-content button:hover {
            background-color: #3498db;
        }
        
        .hamburger-btn {
            background: none;
            border: none;
            color: white;
            cursor: pointer;
            padding: 8px;
            display: flex;
            align-items: center;
        }
        
        .hamburger-btn:hover {
            background-color: rgba(255,255,255,0.1);
            border-radius: 4px;
        }

        .close-btn {
            position: absolute;
            top: 10px;
            right: 10px;
            background: none;
            border: none;
            color: white;
            cursor: pointer;
            padding: 8px;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 50%;
            transition: background-color 0.3s ease;
        }

        .close-btn:hover {
            background-color: rgba(255,255,255,0.1);
        }

        .menu-link {
            text-decoration: none;
            color: white;
            display: block;
        }

        .menu-link button {
            display: flex;
            align-items: center;
            justify-content: space-between;
        }

        .menu-link:hover button {
            background-color: #3498db;
        }
    </style>
</head>
<body>
    <!-- Sidebar -->
    <div class="sidebar" id="sidebar">
        <button class="close-btn" onclick="toggleSidebar()">
            <span class="material-icons">close</span>
        </button>
        <div class="menu-items">
            <div class="dropdown">
                <button class="dropdown-btn" onclick="toggleTimetableView()">
                    View Timetable
                    <span class="material-icons">expand_more</span>
                </button>
                <div id="timetableDropdown" class="dropdown-content" style="display: none;">
                    <!-- Department links will be added here dynamically -->
                </div>
            </div>
            <a href="/add_departments.html" class="menu-link">
                <button class="dropdown-btn" style="width: 100%; margin-top: 10px;">
                    Departments
                    <span class="material-icons">school</span>
                </button>
            </a>
            <a href="/add_faculty.html" class="menu-link">
                <button class="dropdown-btn" style="width: 100%; margin-top: 10px;">
                    Faculty
                    <span class="material-icons">people</span>
                </button>
            </a>
            <a href="/add_subjects.html" class="menu-link">
                <button class="dropdown-btn" style="width: 100%; margin-top: 10px;">
                    Subjects
                    <span class="material-icons">book</span>
                </button>
            </a>
            <a href="/set_constraints.html" class="menu-link">
                <button class="dropdown-btn" style="width: 100%; margin-top: 10px;">
                    Subject Constraints
                    <span class="material-icons">settings</span>
                </button>
            </a>
        </div>
    </div>

    <!-- App Bar -->
    <div style="background: #3498db; color: white; padding: 16px; box-shadow: 0 2px 4px rgba(0,0,0,0.1); position: fixed; top: 0; left: 0; right: 0; z-index: 1000; display: flex; justify-content: space-between; align-items: center;">
        <div style="flex: 1">
            <button class="hamburger-btn" onclick="toggleSidebar()">
                <span class="material-icons">menu</span>
            </button>
        </div>
        <div style="flex: 1; text-align: center;">
            <h1 style="margin: 0; font-size: 20px;">Admin Dashboard</h1>
        </div>
        <div style="flex: 1; display: flex; justify-content: flex-end;">
            <button onclick="logout()" style="background: none; border: 1px solid white; color: white; padding: 8px 16px; border-radius: 4px; cursor: pointer; font-size: 14px;">
                Logout
            </button>
        </div>
    </div>

    <!-- Main Content -->
    <main style="padding: 90px 20px 20px 20px; max-width: 1200px; margin: 0 auto;">
        <div id="adminInfo" style="text-align:center; margin-bottom: 30px;">
            <h2 style="color: #2c3e50; margin-bottom: 10px;">Welcome, <span id="adminName"></span></h2>
            <p style="font-size: 16px; color: #34495e;"><span id="collegeName"></span></p>
        </div>

        <div class="timetable-generator" style="max-width: 800px; margin: 0 auto; padding: 20px; background: white; border-radius: 10px; box-shadow: 0 2px 4px rgba(0,0,0,0.1);">
            <h2 style="margin-bottom: 20px; color: #2c3e50;">Generate Timetable</h2>
            
            <div style="margin-bottom: 20px;">
                <label for="departmentSelect" style="display: block; margin-bottom: 8px; color: #2c3e50; font-weight: 500;">Select Department:</label>
                <select id="department" 
                        style="width: 100%; padding: 10px; border: 2px solid #e0e0e0; border-radius: 5px; 
                               font-size: 16px; margin-bottom: 20px; outline: none; transition: border-color 0.3s ease;"
                        disabled>
                    <option value="" disabled selected>Loading departments...</option>
                </select>
            </div>
            
            <button id="generateButton" 
                    style="width: 100%; background: #3498db; color: white; border: none; 
                           padding: 12px; border-radius: 5px; cursor: pointer; 
                           font-size: 16px; transition: all 0.3s ease;" disabled>
                Generate Timetable
            </button>

            <div id="statusMessage" style="margin-top: 15px; text-align: center; font-size: 14px;"></div>
        </div>

        <!-- Message Display Section -->
        <div id="message" style="margin-top: 20px; text-align: center; font-size: 16px; color: #2c3e50;">
        </div>

        <!-- Timetable Display Section -->
        <div id="timetableContainer" style="margin-top: 30px; display: none;">
            <div class="timetable-controls" style="margin-bottom: 20px; display: flex; justify-content: center; gap: 10px;">
                <div style="margin-bottom: 15px;">
                    <label for="sectionSelect" style="margin-right: 10px;">Select Section:</label>
                    <select id="sectionSelect" style="padding: 8px; border-radius: 4px; border: 1px solid #ccc;">
                    </select>
                </div>
            </div>
            
            <div class="timetable-view" style="overflow-x: auto;">
                <table id="timetableDisplay" style="width: 100%; border-collapse: collapse; margin-top: 20px; background: white; box-shadow: 0 1px 3px rgba(0,0,0,0.2);">
                    <thead>
                        <tr>
                            <th style="border: 1px solid #ddd; padding: 12px; background: #f5f5f5;">Day/Period</th>
                            <th style="border: 1px solid #ddd; padding: 12px; background: #f5f5f5;">P1</th>
                            <th style="border: 1px solid #ddd; padding: 12px; background: #f5f5f5;">P2</th>
                            <th style="border: 1px solid #ddd; padding: 12px; background: #f5f5f5; background-color: #e8f4f8;">Break</th>
                            <th style="border: 1px solid #ddd; padding: 12px; background: #f5f5f5;">P3</th>
                            <th style="border: 1px solid #ddd; padding: 12px; background: #f5f5f5;">P4</th>
                            <th style="border: 1px solid #ddd; padding: 12px; background: #f5f5f5; background-color: #e8f4f8;">Break</th>
                            <th style="border: 1px solid #ddd; padding: 12px; background: #f5f5f5;">P5</th>
                            <th style="border: 1px solid #ddd; padding: 12px; background: #f5f5f5;">P6</th>
                            <th style="border: 1px solid #ddd; padding: 12px; background: #f5f5f5;">P7</th>
                        </tr>
                    </thead>
                    <tbody id="timetableBody">
                    </tbody>
                </table>
            </div>
        </div>
    </main>

    <script>
        function toggleSidebar() {
            document.getElementById('sidebar').classList.toggle('open');
        }

        function toggleTimetableView() {
            const dropdownContent = document.getElementById('timetableDropdown');
            const icon = document.querySelector('.dropdown-btn .material-icons');
            const collegeId = sessionStorage.getItem('college_id');
            
            console.log('Toggle timetable view');
            console.log('College ID:', collegeId);
            console.log('Dropdown content:', dropdownContent);
            
            if (!collegeId) {
                console.error('No college ID found');
                showMessage('Please login again', true);
                window.location.href = 'admin_login.html';
                return;
            }
            
            if (!dropdownContent.classList.contains('show')) {
                dropdownContent.classList.add('show');
                icon.textContent = 'expand_less';
                // Show loading message
                dropdownContent.innerHTML = '<div style="color: white; padding: 8px; text-align: center;">Loading departments...</div>';
                // Load departments when opening the dropdown
                loadDepartmentsWithTimetables();
            } else {
                dropdownContent.classList.remove('show');
                icon.textContent = 'expand_more';
            }
        }
        
        function viewDepartmentTimetable(deptName) {
            // Store selected department in sessionStorage
            sessionStorage.setItem('selected_dept', deptName);
            // Navigate to view_timetables.html
            window.location.href = 'view_timetables.html';
        }

        // Close sidebar when clicking outside
        document.addEventListener('click', function(event) {
            const sidebar = document.getElementById('sidebar');
            const hamburgerBtn = document.querySelector('.hamburger-btn');
            if (!sidebar.contains(event.target) && !hamburgerBtn.contains(event.target) && sidebar.classList.contains('open')) {
                sidebar.classList.remove('open');
            }
        });

        // Function to load departments with timetables
        async function loadDepartmentsWithTimetables() {
            try {
                const collegeId = sessionStorage.getItem('college_id');
                if (!collegeId) {
                    console.error('No college ID found');
                    return;
                }

                console.log('Loading departments with timetables for college:', collegeId);
                const response = await fetch(`http://localhost:5000/get-departments-with-timetables?college_id=${collegeId}`, {
                    headers: {
                        'Accept': 'application/json'
                    },
                    credentials: 'include'
                });

                console.log('Load departments with timetables response:', response);
                const data = await response.json();
                console.log('Departments with timetables data:', data);

                const dropdownContent = document.getElementById('timetableDropdown');
                console.log('Dropdown content element:', dropdownContent);

                dropdownContent.innerHTML = ''; // Clear existing content

                if (response.ok && data.departments && data.departments.length > 0) {
                    data.departments.forEach(dept => {
                        const deptButton = document.createElement('button');
                        deptButton.textContent = dept;
                        deptButton.onclick = () => viewDepartmentTimetable(dept);
                        deptButton.className = 'dropdown-item';
                        dropdownContent.appendChild(deptButton);
                        console.log('Added department button:', dept);
                    });
                } else if (response.ok && (!data.departments || data.departments.length === 0)) {
                    const message = document.createElement('div');
                    message.textContent = 'No timetables available';
                    message.style.color = 'white';
                    message.style.padding = '8px';
                    message.style.textAlign = 'center';
                    dropdownContent.appendChild(message);
                } else {
                    console.error('Failed to load departments:', data.error);
                    const errorMsg = document.createElement('div');
                    errorMsg.textContent = 'Failed to load departments';
                    errorMsg.style.color = '#ff6b6b';
                    errorMsg.style.padding = '8px';
                    errorMsg.style.textAlign = 'center';
                    dropdownContent.appendChild(errorMsg);
                }
            } catch (error) {
                console.error('Error loading departments with timetables:', error);
                const dropdownContent = document.getElementById('timetableDropdown');
                dropdownContent.innerHTML = '<div style="color: #ff6b6b; padding: 8px; text-align: center;">Error loading departments</div>';
            }
        }

        // Function to view a specific department's timetable - this redirects to view_timetables.html
        function viewDepartmentTimetable(deptName) {
            // Store selected department in sessionStorage
            sessionStorage.setItem('selected_dept', deptName);
            // Navigate to view_timetables.html
            window.location.href = 'view_timetables.html';
        }

        // Get admin info from URL parameters or sessionStorage
        window.onload = function() {
            const urlParams = new URLSearchParams(window.location.search);
            const adminName = urlParams.get('admin_name') || sessionStorage.getItem('admin_name');
            const collegeName = urlParams.get('college_name') || sessionStorage.getItem('college_name');
            const collegeId = urlParams.get('college_id') || sessionStorage.getItem('college_id');
            
            if (adminName && collegeName && collegeId) {
                document.getElementById('adminName').textContent = adminName;
                document.getElementById('collegeName').textContent = `College: ${collegeName}`;
                
                // Store in session
                sessionStorage.setItem('admin_name', adminName);
                sessionStorage.setItem('college_name', collegeName);
                sessionStorage.setItem('college_id', collegeId);
            } else {
                // Redirect to login if no admin info
                console.log('Missing admin info, redirecting to login');
                window.location.href = 'admin_login.html';
            }
        };

        // Logout function
        function logout() {
            // Clear session storage
            sessionStorage.removeItem('admin_name');
            sessionStorage.removeItem('college_name');
            // Redirect to login page
            window.location.href = 'admin_login.html';
        };

        // Handle timetable generation
        document.getElementById('generateButton').addEventListener('click', async function() {
            const messageDiv = document.getElementById('statusMessage');
            const button = this;
            const selectedDepartment = document.getElementById('department').value;
            const collegeId = sessionStorage.getItem('college_id');
            
            if (!selectedDepartment) {
                messageDiv.style.color = 'red';
                messageDiv.textContent = 'Please select a department first';
                return;
            }
            
            if (!collegeId) {
                messageDiv.style.color = 'red';
                messageDiv.textContent = 'Session expired. Please login again.';
                window.location.href = 'admin_login.html';
                return;
            }
            
            try {
                // Disable button and show generating status
                button.disabled = true;
                button.textContent = 'Generating...';
                messageDiv.style.color = '#3498db';
                messageDiv.textContent = 'Generating timetables... This may take a few moments.';
                
                // Use relative URL and add timestamp to prevent caching
                const response = await fetch('/generate-timetable', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Accept': 'application/json',
                        'Cache-Control': 'no-cache'
                    },
                    credentials: 'include',
                    body: JSON.stringify({
                        dept_name: selectedDepartment,
                        college_id: collegeId,
                        timestamp: new Date().getTime()
                    })
                });
                
                console.log('Server response:', response);
                const data = await response.json();
                console.log('Response data:', data);
                
                if (response.ok) {
                    if (data.ok) {
                        messageDiv.style.color = '#2ecc71';
                        messageDiv.textContent = 'Timetables generated successfully! Redirecting to view timetables...';
                        
                        // Store department info for viewing
                        sessionStorage.setItem('selected_dept', selectedDepartment);
                        
                        // Redirect to view timetables after a short delay
                        setTimeout(() => {
                            window.location.href = 'view_timetables.html';
                        }, 1500);
                    } else {
                        messageDiv.style.color = '#e74c3c';
                        messageDiv.textContent = data.error || 'Failed to generate timetable. Please try again.';
                        console.error('Server returned error:', data);
                    }
                } else {
                    throw new Error(response.statusText);
                }
            } catch (error) {
                console.error('Error details:', error);
                messageDiv.style.color = '#e74c3c';
                
                // Provide more specific error messages
                if (error.message.includes('Failed to fetch')) {
                    messageDiv.textContent = 'Cannot connect to server. Please check if the server is running.';
                } else if (error.name === 'TypeError') {
                    messageDiv.textContent = 'Network error. Please check your internet connection.';
                } else {
                    messageDiv.textContent = `Error: ${error.message}`;
                }
            } finally {
                // Re-enable button with original text
                button.disabled = false;
                button.textContent = 'Generate Timetable';
            }
        });

        // Function to load timetables
        async function loadTimetables() {
            try {
                const collegeId = sessionStorage.getItem('college_id');
                const dept = document.getElementById('department').value;

                if (!collegeId || !dept) {
                    console.error('Missing college ID or department');
                    return;
                }

                const response = await fetch('http://localhost:5000/get-timetables', {
                    headers: {
                        'Content-Type': 'application/json',
                        'Accept': 'application/json'
                    },
                    credentials: 'include'  // Include credentials for session cookies
                });
                
                console.log('Load timetables response:', response);
                const data = await response.json();
                console.log('Load timetables data:', data);
                
                if (response.ok && data.ok) {
                    if (data.timetables) {
                        displayTimetable(data.timetables);
                    } else {
                        console.error('No timetables found in response:', data);
                        showMessage('No timetables available', true);
                    }
                } else {
                    throw new Error(data.error || 'Failed to load timetables');
                }
            } catch (error) {
                console.error('Error loading timetables:', error);
                showMessage('Failed to load timetables: ' + error.message, true);
            }
        }

        function displayTimetable(timetableData) {
            console.log('Displaying timetable data:', timetableData);
            
            const timetableContainer = document.getElementById('timetableContainer');
            const sectionSelect = document.getElementById('sectionSelect');
            const timetableBody = document.getElementById('timetableBody');
            
            if (!timetableData || Object.keys(timetableData).length === 0) {
                console.error('No timetable data to display');
                showMessage('No timetable data available', true);
                return;
            }
            
            // Clear previous options
            sectionSelect.innerHTML = '';
            
            // Add options for each section
            Object.keys(timetableData).forEach(section => {
                const option = document.createElement('option');
                option.value = section;
                option.textContent = section;
                sectionSelect.appendChild(option);
            });

            // Function to display timetable for selected section
            function showSectionTimetable(section) {
                const days = ['Monday', 'Tuesday', 'Wednesday', 'Thursday', 'Friday'];
                timetableBody.innerHTML = '';

                days.forEach(day => {
                    const row = document.createElement('tr');
                    
                    // Add day cell
                    const dayCell = document.createElement('td');
                    dayCell.textContent = day;
                    dayCell.style.cssText = 'border: 1px solid #ddd; padding: 12px; font-weight: bold; background: #f5f5f5;';
                    row.appendChild(dayCell);

                    // Add period cells
                    for (let period = 1; period <= 9; period++) {
                        const cell = document.createElement('td');
                        if (period === 3 || period === 6) {
                            // Break periods
                            cell.textContent = 'Break';
                            cell.style.cssText = 'border: 1px solid #ddd; padding: 12px; background-color: #e8f4f8;';
                        } else {
                            const periodKey = period > 6 ? period - 2 : period > 3 ? period - 1 : period;
                            const slot = timetableData[section][day.toLowerCase()][periodKey - 1];
                            
                            if (slot) {
                                let displayText = [];
                                if (slot.subject_code) {
                                    displayText.push(slot.subject_code);
                                    if (slot.faculty_name) {
                                        displayText.push(slot.faculty_name);
                                    }
                                    if (slot.is_lab) {
                                        displayText.push('(Lab)');
                                        cell.style.backgroundColor = '#e8f5e9'; // Light green for labs
                                    }
                                }
                                cell.innerHTML = displayText.join('<br>');
                            }
                            cell.style.cssText = `border: 1px solid #ddd; padding: 12px; text-align: center; ${slot && slot.is_lab ? 'background-color: #e8f5e9;' : ''}`;
                        }
                        row.appendChild(cell);
                    }
                    timetableBody.appendChild(row);
                });
            }

            // Show timetable for first section initially
            if (sectionSelect.options.length > 0) {
                showSectionTimetable(sectionSelect.value);
            }

            // Update timetable when section changes
            sectionSelect.addEventListener('change', (e) => {
                showSectionTimetable(e.target.value);
            });

            // Show the timetable container
            timetableContainer.style.display = 'block';
        }

        // Function to fetch departments from the server
        async function loadDepartments() {
            try {
                // Get college_id from session storage
                const collegeId = sessionStorage.getItem('college_id');
                if (!collegeId) {
                    console.log('No college ID found, redirecting to login...');
                    window.location.href = 'admin_login.html';
                    return;
                }

                const response = await fetch(`http://localhost:5000/get-departments?college_id=${collegeId}`, {
                    headers: {
                        'Accept': 'application/json'
                    },
                    credentials: 'include'
                });
                
                console.log('Load departments response:', response);
                const data = await response.json();
                console.log('Load departments data:', data);
                
                if (!response.ok) {
                    throw new Error(data.error || 'Failed to load departments');
                }

                if (!data.departments || !Array.isArray(data.departments)) {
                    throw new Error('Invalid department data received from server');
                }

                const deptSelect = document.getElementById('department');
                const generateButton = document.getElementById('generateButton');
                const statusMessage = document.getElementById('statusMessage');
                
                if (!deptSelect) {
                    throw new Error('Department select element not found');
                }
                
                deptSelect.innerHTML = '<option value="">Select Department</option>';
                data.departments.forEach(dept => {
                    const option = document.createElement('option');
                    option.value = dept.name;
                    option.textContent = dept.name;
                    deptSelect.appendChild(option);
                });
                
                // Enable the select element
                deptSelect.disabled = false;
                
                // Update button state when department is selected
                deptSelect.addEventListener('change', () => {
                    if (generateButton) {
                        generateButton.disabled = !deptSelect.value;
                    }
                    if (statusMessage) {
                        statusMessage.textContent = '';
                    }
                });
            } catch (error) {
                console.error('Error loading departments:', error);
                const errorMessage = error.message || 'Failed to load departments. Please try again later.';
                const statusMessage = document.getElementById('statusMessage');
                if (statusMessage) {
                    statusMessage.style.color = 'red';
                    statusMessage.textContent = errorMessage;
                } else {
                    alert(errorMessage);
                }
                
                // Log additional debugging information
                console.log('Session check:', document.cookie.includes('session'));
            }
        }

        // Load departments when the page loads
        document.addEventListener('DOMContentLoaded', loadDepartments);
    </script>
</body>
</html>